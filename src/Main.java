
// DOCS: https://0110.be/releases/TarsosDSP/TarsosDSP-latest/TarsosDSP-latest-Documentation/

import java.util.ArrayList;

import javax.sound.sampled.AudioFormat;
import javax.sound.sampled.LineUnavailableException;
import be.tarsos.dsp.AudioDispatcher;
import be.tarsos.dsp.AudioEvent;
import be.tarsos.dsp.AudioProcessor;
import be.tarsos.dsp.filters.HighPass;
import be.tarsos.dsp.io.jvm.AudioDispatcherFactory;
import be.tarsos.dsp.io.jvm.AudioPlayer;
import be.tarsos.dsp.pitch.PitchDetectionHandler;
import be.tarsos.dsp.pitch.PitchDetectionResult;
import be.tarsos.dsp.pitch.PitchProcessor;
import be.tarsos.dsp.pitch.PitchProcessor.PitchEstimationAlgorithm;

public class Main {

	public static void main(String[] args) throws LineUnavailableException {		
		int BUFFER_SIZE = 1024;
		int SAMPLE_RATE = 44100;
		
		// set up audio stream from default mic
		AudioDispatcher d = AudioDispatcherFactory.fromDefaultMicrophone(BUFFER_SIZE, 0);
		
		// remove any frequencies below 110 Hz
		d.addAudioProcessor(new HighPass(110, SAMPLE_RATE));
		
		// create new PSOLA object for pitch shifting
		PSOLA psola = new PSOLA(BUFFER_SIZE, SAMPLE_RATE);
		
		
		
		
		// MAKE IT PRIVATE !!!!!!!!!!
		
		
		
		
		
		
//		double[] t = {0.18120071, 0.17838301, 0.16467759, 0.14370584, 0.12387779, 0.1044792, 0.08174852, 0.055374183, 0.030833177, 0.013123697, -0.0033413982, -0.01779414, -0.0245124, -0.02737132, -0.02746047, -0.02488349, -0.022437425, -0.015456924, -0.00416392, 0.0038042269, 0.008953444, 0.009328991, -7.18032E-4, -0.020389661, -0.05092917, -0.09637664, -0.15653054, -0.22755873, -0.30378088, -0.37972623, -0.45115966, -0.5134275, -0.56279624, -0.59459126, -0.6080864, -0.609229, -0.595728, -0.56644833, -0.5326883, -0.50054324, -0.47280437, -0.45046297, -0.4306492, -0.4161097, -0.4051878, -0.3944054, -0.38709137, -0.37607563, -0.3525433, -0.32135245, -0.28268263, -0.23401567, -0.17823243, -0.11156748, -0.03909564, 0.027888753, 0.09937298, 0.18088911, 0.25680745, 0.3172828, 0.36809674, 0.4127607, 0.44404233, 0.45996943, 0.45887306, 0.44334957, 0.42546332, 0.39937648, 0.35867578, 0.31754813, 0.2817839, 0.24581878, 0.21095799, 0.17869842, 0.14778836, 0.122022286, 0.10135045, 0.078880385, 0.051006302, 0.020476978, -0.010455763, -0.044420116, -0.079340085, -0.113807894, -0.1474672, -0.1744863, -0.19669445, -0.21773966, -0.23243167, -0.23460102, -0.2260171, -0.21344838, -0.19338371, -0.1640016, -0.12935324, -0.08912687, -0.04701268, -0.0044026896, 0.037272178, 0.07051672, 0.0938874, 0.11114123, 0.12434161, 0.129615, 0.12496498, 0.11969082, 0.119010575, 0.11776556, 0.115480065, 0.11789342, 0.12771842, 0.14344689, 0.16077794, 0.17690076, 0.19613409, 0.21951967, 0.23818111, 0.24798279, 0.25351378, 0.2558701, 0.25289056, 0.24559684, 0.23342012, 0.21749625, 0.20330372, 0.19451001, 0.18667062, 0.17332083, 0.16223776, 0.16101702, 0.16405465, 0.16544013, 0.16613787, 0.17230567, 0.18431267, 0.19328652, 0.19206749, 0.18496256, 0.18008779, 0.17271492, 0.15346533, 0.12709618, 0.103347614, 0.08217886, 0.059643537, 0.03461222, 0.0100912675, -0.0083858045, -0.023062915, -0.037935738, -0.049821697, -0.05716233, -0.058181163, -0.053461, -0.045119926, -0.03515225, -0.025884636, -0.013157664, 7.9461746E-4, 0.008837068, 0.0066405255, -0.008361096, -0.035786994, -0.0782904, -0.13884667, -0.21257234, -0.287998, -0.36094865, -0.4310389, -0.49368015, -0.5452637, -0.5791785, -0.5902183, -0.5838565, -0.5665712, -0.5431048, -0.5208512, -0.49985206, -0.47787738, -0.465571, -0.46523538, -0.46012053, -0.4490593, -0.44513473, -0.44372395, -0.42792135, -0.3931055, -0.34796014, -0.3024267, -0.25566325, -0.19167024, -0.11356202, -0.043723904, 0.02257542, 0.0995929, 0.18049999, 0.2542138, 0.31609213, 0.3678633, 0.4153168, 0.4537656, 0.4700563, 0.46341297, 0.4474858, 0.42823318, 0.39868143, 0.36298797, 0.3249425, 0.28385493, 0.25085545, 0.22300215, 0.1926144, 0.16678718, 0.14699386, 0.12762946, 0.10111701, 0.06632611, 0.028018542, -0.011177121, -0.048037253, -0.08580799, -0.126504, -0.16114683, -0.18637857, -0.20613071, -0.22060958, -0.22729298, -0.22566627, -0.21967405, -0.20799129, -0.18740584, -0.16229552, -0.13227645, -0.09409401, -0.051690616, -0.011097282, 0.024140941, 0.05559111, 0.08319101, 0.102761135, 0.113124266, 0.11378766, 0.112956956, 0.11752923, 0.11909312, 0.11872497, 0.12511528, 0.1390068, 0.15879911, 0.18131177, 0.20138493, 0.2230537, 0.25056285, 0.27467668, 0.2879988, 0.2922111, 0.29393536, 0.29384625, 0.2883987, 0.27743384, 0.26346, 0.25339773, 0.24594472, 0.2331267, 0.21629892, 0.20339686, 0.1958735, 0.18943612, 0.18222071, 0.17769139, 0.17959155, 0.18582268, 0.19156326, 0.19282378, 0.19203584, 0.19086654, 0.1831141, 0.16455068, 0.1408253, 0.119558275, 0.09856138, 0.074711464, 0.050263435, 0.02840608, 0.010249844, -0.006564214, -0.02108797, -0.030268352, -0.037186295, -0.04381497, -0.048705384, -0.050279662, -0.047226712, -0.042586047, -0.036685176, -0.029604249, -0.024238337, -0.019803744, -0.02146407, -0.03605894, -0.066627316, -0.11691792, -0.18050727, -0.2484676, -0.3229717, -0.39946645, -0.46732253, -0.5227983, -0.5626645, -0.58731514, -0.59638125, -0.5810209, -0.549487, -0.5228342, -0.5038028, -0.48579404, -0.46773225, -0.45434213, -0.44464254, -0.43527547, -0.43120188, -0.42640433, -0.40953863, -0.38018677, -0.33808872, -0.28589547, -0.23045614, -0.16870227, -0.099460244, -0.0352012, 0.0279072, 0.104266435, 0.18395016, 0.25282592, 0.3128484, 0.371453, 0.4284498, 0.47332594, 0.4969736, 0.49742153, 0.48587108, 0.46717218, 0.43150377, 0.38621554, 0.34381178, 0.30197656, 0.26015598, 0.21953078, 0.17908306, 0.14707692, 0.12774152, 0.10903987, 0.08260452, 0.049585287, 0.015171781, -0.017646743, -0.05383093, -0.09541784, -0.13666089, -0.16963172, -0.19415618, -0.21627042, -0.23474014, -0.24329326, -0.23887408, -0.22777092, -0.21823336, -0.20493782, -0.17894924, -0.1434628, -0.10553037, -0.064735726, -0.02194098, 0.020339703, 0.060206603, 0.09076285, 0.11136593, 0.12671277, 0.13479573, 0.13412285, 0.13019004, 0.126167, 0.12172202, 0.12122216, 0.12714969, 0.138042, 0.15470004, 0.17382438, 0.19262105, 0.21497114, 0.23869972, 0.254489, 0.25907093, 0.25891832, 0.25785965, 0.25182104, 0.24039544, 0.2275729, 0.21809897, 0.21192162, 0.20093477, 0.18285125, 0.1670778, 0.15987696, 0.15472607, 0.14456807, 0.13341732, 0.12907158, 0.13408974, 0.14223967, 0.14472142, 0.14807299, 0.15827659, 0.15984276, 0.1445785, 0.124403775, 0.106632195, 0.08904612, 0.0669188, 0.03644485, 0.005748298, -0.0151140075, -0.03219984, -0.0512608, -0.06605852, -0.07248047, -0.07592585, -0.08110424, -0.08456692, -0.082313165, -0.07231218, -0.05774285, -0.050122503, -0.04567906, -0.034006935, -0.02515078, -0.029877212, -0.046763755, -0.07607555, -0.124493204, -0.19035698, -0.26113167, -0.33080578, -0.39688316, -0.4567246, -0.5081258, -0.5418308, -0.5542689, -0.5512822, -0.5351394, -0.50816464, -0.47961074, -0.4608578, -0.45281327, -0.4486789, -0.44221663, -0.43173662, -0.42693073, -0.43125367, -0.42954403, -0.410752, -0.37838343, -0.33888736, -0.2945851, -0.24140286, -0.17548163, -0.10749684, -0.048412025, 0.017475698, 0.10380826, 0.19218984, 0.2647832, 0.32637602, 0.38810122, 0.4495327, 0.494505, 0.51037407, 0.50486016, 0.4904687, 0.4654301, 0.42458043, 0.37573582, 0.33079997, 0.2930431, 0.25817472, 0.22206196, 0.1880551, 0.16502406, 0.15158695, 0.13172719, 0.09976095, 0.061932743, 0.022058304, -0.01677215, -0.05711846, -0.10056197, -0.13960534, -0.16886637, -0.19282737, -0.2147806, -0.23097211, -0.23731269, -0.23289567, -0.22400519, -0.21258816, -0.19389951, -0.16623542, -0.12964462, -0.08690035, -0.040006086, 0.007763885, 0.05018828, 0.08671431, 0.11543515, 0.1343222, 0.14543606, 0.14614207, 0.14362729, 0.14575435, 0.14342728, 0.13928926, 0.14632878, 0.16334248, 0.18708657, 0.2116727, 0.2303956, 0.25327867, 0.27907634, 0.29384407, 0.2995098, 0.30036354, 0.29705548, 0.28904474, 0.27679804, 0.26540795, 0.2540436, 0.24552071, 0.24170281, 0.23091908, 0.21457982, 0.2033397, 0.19478765, 0.18627776, 0.1746904, 0.16295011, 0.16286898, 0.1666651, 0.16513328, 0.16692592, 0.17032588, 0.16967583, 0.16167757, 0.14199397, 0.119224995, 0.0970826, 0.07092403, 0.043113098, 0.015855767, -0.008524923, -0.030861033, -0.051941372, -0.06494191, -0.07253192, -0.07982222, -0.08378934, -0.08751308, -0.0892712, -0.08415843, -0.078428686, -0.070789486, -0.058848016, -0.054117482, -0.05388157, -0.054133825, -0.0704312, -0.10585514, -0.15720122, -0.22052754, -0.28732044, -0.36234078, -0.4407973, -0.50613326, -0.5543134, -0.5869065, -0.60442746, -0.60044885, -0.5733064, -0.5410143, -0.51443267, -0.49041432, -0.46870756, -0.45272836, -0.44620314, -0.43993077, -0.42554975, -0.41708523, -0.4139001, -0.39220217, -0.35385382, -0.31298286, -0.26799327, -0.21785903, -0.15778482, -0.09086253, -0.031824425, 0.027779408, 0.104140624, 0.18670303, 0.2569592, 0.31743217, 0.38068932, 0.442115, 0.48844415, 0.5113722, 0.50681186, 0.49054292, 0.4712263, 0.43273926, 0.3824051, 0.33694163, 0.29306325, 0.25371295, 0.21975896, 0.18469778, 0.15754016, 0.14234197, 0.12547243, 0.097479455, 0.058233216, 0.017477587, -0.015770448, -0.05019722, -0.094687074, -0.14057449, -0.17496826, -0.19798651, -0.22046514, -0.24253365, -0.25553805, -0.25807482, -0.25288075, -0.24649565, -0.2373028, -0.21302146, -0.1757031, -0.13545245, -0.09361717, -0.049252898, -0.002822917, 0.0412196, 0.07500838, 0.09449378, 0.10480377, 0.110926054, 0.11453062, 0.11671649, 0.11478041, 0.115327194, 0.12719068, 0.14577378, 0.16646016, 0.19039802, 0.21638615, 0.24169762, 0.26622182, 0.28657952, 0.2978391, 0.30356383, 0.30674675, 0.30279437, 0.29275635, 0.28123927, 0.26956818, 0.26031938, 0.25160804, 0.23679422, 0.21797143, 0.2019244, 0.19015428, 0.17923337, 0.16472743, 0.1521731, 0.15013985, 0.15540576, 0.15983272, 0.16043597, 0.16402769, 0.1705614, 0.16536552, 0.1456246, 0.12092173, 0.098722674, 0.08016947, 0.055515416, 0.026006103, 0.0025274027, -0.017618628, -0.034574673, -0.045846708, -0.055641368, -0.06110491, -0.0637279, -0.06827839, -0.06924549, -0.0660793, -0.059358887, -0.046383917, -0.03242974, -0.023749523, -0.01962534, -0.013839262, -0.00977834, -0.026341524, -0.07329174, -0.13631795, -0.20299713, -0.2753316, -0.35332423, -0.43013433, -0.49275935, -0.53524256, -0.565104, -0.58148026, -0.57337683, -0.5408716, -0.50296706, -0.47979325, -0.4670937, -0.45232058, -0.4369293, -0.42771247, -0.4239987, -0.42203847, -0.42346996, -0.41779336, -0.3956412, -0.3601464, -0.31472626, -0.2653188, -0.2086854, -0.14427221, -0.082223326, -0.023531534, 0.045330524, 0.12814125, 0.20357773, 0.26448712, 0.32266277, 0.3806908, 0.43533346, 0.46880767, 0.46990553, 0.4566936, 0.43941742, 0.4086925, 0.36218432, 0.31503674, 0.27413347, 0.23313951, 0.193964, 0.15788072, 0.12575005, 0.10553504, 0.09374974, 0.07469852, 0.04483034, 0.010309093, -0.022433816, -0.050942972, -0.083944656, -0.12236826, -0.15537967, -0.17773354, -0.19216947, -0.20559362, -0.2169316, -0.21492092, -0.20255506, -0.18901883, -0.17081779, -0.1483879, -0.11764638, -0.07593658, -0.034269758, 0.008475184, 0.05524901, 0.09932722, 0.13669404, 0.16127646, 0.1763317, 0.18679231, 0.18688549, 0.18270758, 0.1785038, 0.17000486, 0.16436341, 0.16480537, 0.17017628, 0.18351851, 0.19837928, 0.21264559, 0.23150475, 0.2484052, 0.2599253, 0.26711774, 0.26789984, 0.2646424, 0.25419837, 0.23925346, 0.22871974, 0.21883434, 0.2090118, 0.19891806, 0.18516585, 0.1734141, 0.16302603, 0.15273896, 0.14700261, 0.14074986, 0.1341704, 0.13381007, 0.1362412, 0.14090562, 0.14567919, 0.1449279, 0.14109963, 0.13075987, 0.11195074, 0.09373689, 0.07741118, 0.057978116, 0.035152942, 0.009775706, -0.012784421, -0.029300857, -0.04471258, -0.056886815, -0.0645718, -0.0716225, -0.07586853, -0.07910982, -0.07833386, -0.06560889, -0.049417764, -0.037172727, -0.026450472, -0.014623141, 4.1176658E-4, 0.009338327, 0.0031368723, -0.023165729, -0.073920205, -0.13723946, -0.20496416, -0.28408128, -0.3647843, -0.43160513, -0.48757568, -0.5312599, -0.55918473, -0.56675035, -0.5420396, -0.50444996, -0.48119256, -0.46453467, -0.44653097, -0.4304121, -0.42078182, -0.41778147, -0.41325316, -0.41015798, -0.40750453, -0.39635304, -0.3756547, -0.33713976, -0.28614223, -0.23784545, -0.18257795, -0.122598186, -0.070546046, -0.010340087, 0.06612939, 0.14174286, 0.20540039, 0.26361668, 0.32743818, 0.38963133, 0.4341421, 0.45637026, 0.45729816, 0.44443363, 0.42017147, 0.3765432, 0.32559913, 0.28080708, 0.23646924, 0.1927906, 0.15357631, 0.12139146, 0.1003055, 0.08896489, 0.07919356, 0.06200388, 0.03439223, 0.004817728, -0.021934949, -0.05429758, -0.09057803, -0.12429574, -0.152735, -0.17055751, -0.18704304, -0.2071785, -0.21173912, -0.19960442, -0.19038372, -0.18351695, -0.16839933, -0.14352399, -0.11016305, -0.071446344, -0.029546522, 0.016213648, 0.06392698, 0.105720274, 0.13426669, 0.15537423, 0.17258036, 0.175529, 0.16955942, 0.1655298, 0.15514322, 0.1433738, 0.1412957, 0.14424634, 0.15417634, 0.17152222, 0.19183847, 0.21635069, 0.24023952, 0.2580034, 0.26904118, 0.2768186, 0.28405115, 0.28084537, 0.26775715, 0.2592027, 0.2510841, 0.23927629, 0.23204288, 0.22262058, 0.20471463, 0.18935822, 0.18111445, 0.1747249, 0.1657094, 0.15934744, 0.16344057, 0.16971089, 0.1736126, 0.17600013, 0.1806519, 0.19383125, 0.19602548, 0.17671625, 0.15461856, 0.13558982, 0.11204226, 0.08268351, 0.05126793, 0.022854231, -0.0015141685, -0.024231829, -0.046535656, -0.06691803, -0.08001878, -0.0882525, -0.09959827, -0.10958664, -0.11296979, -0.113998964, -0.1060186, -0.088866, -0.08085253, -0.079474136, -0.0717884, -0.07024814, -0.09589409, -0.1508774, -0.21654287, -0.27815908, -0.34659946, -0.42908585, -0.5090481, -0.565813, -0.5946541, -0.6145376, -0.62466425, -0.5995677, -0.5504245, -0.51097846, -0.48749834, -0.4707424, -0.4554583, -0.43874642, -0.4263218, -0.42450714, -0.42677838, -0.42286724, -0.40817615, -0.3791786, -0.33476457, -0.28774056, -0.2432343, -0.17961629, -0.10920523, -0.060571164, -0.003911808, 0.08196601, 0.17077807, 0.2428868, 0.30209482, 0.36580247, 0.43772495};
//		
//		float[] test = new float[t.length];
//		
//		for (int i = 0; i < t.length; i++) {
//			test[i] = (float) t[i];
//		}
//		float freq = 320.7386f;
//		
//		// analyze mic audio using pitch estimate
//		psola.analyze(test, freq);
//		
//		int[] m = psola.getMapping(psola.getSynthesisPeaks(440));
//		
//		for (int i = 0; i < m.length; i++) {
//			System.out.print(m[i]+ ", ");
//		}
		
		// setup new PitchDetection handler
		PitchDetectionHandler handler = new PitchDetectionHandler() {
	        @Override
	        public void handlePitch(PitchDetectionResult result, AudioEvent audioEvent) {
	        	// if pitch detected
	        	if (result.getPitch() != -1) {
	        		

	        		
//	        		// analyze mic audio using pitch estimate
//	        		psola.analyze(audioEvent.getFloatBuffer(), result.getPitch());
	        		

//	        		float[] buffer = audioEvent.getFloatBuffer();
//	        		for (int i = 0; i < buffer.length; i++) {
//	        			System.out.print(buffer[i] + ", ");
//	        		}
//	        		System.out.println();
	        		
	        		
//	        		// generate shifted audio buffer
//	        		float[] shifted = psola.shift(440);
//	        		
//	        		// replace audio with shifted signal
//	        		audioEvent.setFloatBuffer(shifted);
	        		
	        	// if no pitch detected
	        	} else {
	        		// do not play audio if no pitch detected
	        		audioEvent.clearFloatBuffer();
	        	}
	        }
	    };
	    
	    // add pitch detection with YIN algorithm, using above handler
	    d.addAudioProcessor(new PitchProcessor(PitchEstimationAlgorithm.YIN, SAMPLE_RATE, BUFFER_SIZE, handler));
	    
	    // add an audio player that plays back audio in realtime
	    d.addAudioProcessor(new AudioPlayer(new AudioFormat(SAMPLE_RATE, 16, 1, true, true)));
	    
	    // run audio dispatcher
		d.run();
	}

}